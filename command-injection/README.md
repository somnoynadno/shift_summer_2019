# Command injection

## Описание
Command injection – это атака, основанная на внедрении вредоносного кода в уязвимом приложении. Атаке подвержены сервисы не фильтрующие пользовательский ввод и исполнющие команды операционной системы с помощью функции exec().

Подробное описание: [owasp.org](https://www.owasp.org/index.php/Command_Injection)

## Классификация
- Обычная инъекция (результаты атаки видны непосредственно на веб-странице)
- Слепая (blind) инъекция (уязвимое приложение не выводит результаты внедрённой команды. Случается, например, если команда исполняется в отдельном потоке)
- Полуслепая (semi-blind) или файловая инъекция (атакующий не способен наблюдать результаты работы, но может детектировать наличие уязвимости другим способом, например, добавляя в эксплойт команду sleep или пытаясь создать в системе новые файлы и каталоги) 

## Условия
- Характерна для серверных ОС
- Инъекции подвержены практически все языки программирования
- Обязательно наличие функций, обращающихся к операционной системе (e.g. exec() или shell_exec()), в языке программирования, на котором написан сервис
- Атака проходит при отсутсвии или неправильной фильтрации пользовательского ввода

## Детектирование
Проблема детектируется в ходе пентеста, во время проверки полей для пользовательского ввода. Обратить внимание следует на приложения, которые использую bash для выполнения своих функций. Данная уязвимость обнаруживается как автоматически, так и вручную. Код ревью предпочтительнее, так как другой специалист может предложить безопасные варианты реализации функций, исполняемых уязвимым приложением.

## Эксплуатация
Здесь необходимо описать пример ручной эксплуатации. Сразу уточните какой это язык, какие компоненты используются, если эксплуатация специфична только для этих условий. Можно записать сюда порядок действий при эксплуатации тестового задания

### Инструменты
-Commix – программа для автоматического поиска возможности внедрения команд ОС. Программу Commix нужно запускать от имени администратора. Нужно указать ключ -u с адресом тестируемого веб-приложения (сайта). Адрес должен содержать переменные, которые будут тестироваться.

Пример команды для данной уязвимости:
sudo commix -u http://127.0.0.1:1337/?curl=ya.ru
[kali.tools](https://kali.tools/?p=1107)

## Ущерб
- Компрометация файлов на сервере
- Исполнение произвольного кода
- В худшем случае хакер может получить полный контроль над уязвимой системой

## Защита
### Основные меры
#### Первый способ
Исключение использования потенциально опасной функции exec(), замена исполняемой функции средствами языка. Например, исполнение curl через bash можно заменить на исполнение библиотечной функции curl в php, работу с файлами можно осуществлять стандартными функциями языка и т.д. 
Если библиотечные функции отстуствуют, то можно попробовать создать собственную реализацию.

#### Второй способ
Если выбросить функцию exec() не представляется возможным, то необходимо предпринять следующие меры:
- Отрегулировать права на доступ к файлам и каталогам на сервере (например, для *nix через функции chmod, chown)
- Фильтровать пользовательский ввод средствами языка (по подстрокам и регулярным выражениям). Потенциально опасные символы – любые разделители shell-команд (';', '&&', '||', '&', '|'), апостро и кавычки.

Пример обнаружения разделителей по регулярному выражению в php:
```
if (preg_match("/[;&|]/", $_GET['curl'])){
  echo "Security alert";
} else {
  curl($_GET['curl']);
}
```

### Превентивные меры
Превентивные меры зависят от ущерба, который уже успел нанести злоумышленник, и степени его закрепления в системе.

## Обход защиты
Всегда можно попробовать обойти плохое фильтрование пользовательского ввода, например, при замене символов их байткодом в URL.
