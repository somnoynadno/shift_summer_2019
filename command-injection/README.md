# Command injection

## Описание
Command injection – это атака, основанная на внедрении вредоносного кода в уязвимом приложении. Атаке подвержены сервисы не фильтрующие пользовательский ввод и исполняющие команды операционной системы с помощью функции exec() и ей подобных.

Причиной возникновения является то, что bash/powershell выполняет не одну команду, а полностью интерпретирует строку, поданую на вход. Суть атаки состоит в том, чтобы путём модификации ввода на выполнение пошла строка вида "легитимная_команда <разделитель> вредоносная_команда", где добавляются разделители вида ';', '&&' и прочие, в т.ч. кавычки и нуль-терминатор.

Подробное описание: [owasp.org](https://www.owasp.org/index.php/Command_Injection)

## Классификация
- Обычная инъекция (результаты атаки видны непосредственно на веб-странице)
- Слепая (blind) инъекция (уязвимое приложение не выводит результаты внедрённой команды. Случается, например, если команда исполняется в отдельном потоке)
- Полуслепая (semi-blind) или файловая инъекция (атакующий не способен наблюдать результаты работы, но может детектировать наличие уязвимости другим способом, например, добавляя в эксплойт команду sleep или пытаясь создать в системе новые файлы и каталоги) 

## Условия
- Характерна для серверных ОС
- Инъекции подвержены практически все языки программирования
- Обязательно наличие функций, обращающихся к операционной системе (e.g. exec() или shell_exec()), в языке программирования, на котором написан сервис
- Атака проходит при отсутсвии или неправильной фильтрации пользовательского ввода

## Детектирование
### White-box
Наличие вызова bash из исполняемого кода приложения, в который передаётся строка, содержащая пользовательский ввод (особенно если он не проходит дополнительные фильтрации), сигнализирует о возможной уязвимости. 

### Black-box
#### Обычная инъекция
При обнаружении input-box на веб-странице необходимо предположить, как он будет обрабатываться. Например, если из ввода будет формироваться запрос к базе данных, то с помощью нетривиальных модификаций ввода с помощью кавычек можно сдетектировать SQL-инъекцию (https://github.com/RegularAlex/shift_summer_2019/blob/master/example/SQLi.md)

Аналогично детектируется и bash-инъекция, если пользовательсий ввод является частью команды, исполняемой через шелл. Для обнаружения необходимо попробовать добавить в ввод shell-команды и их разделители.

##### Пример уязвимого кода:
```
function curl($target){
	$result=shell_exec('curl -vvv -L -sD - -o /dev/null '.$target );
	echo $result;
}
```
Функция вызывается из PHP-скрипта как `curl($_GET['curl'])`, где параметром передаётся пользовательский ввод.
При передаче валидного адреса, скрипт обратится к нему утилитой curl и выведет содержимое на страницу. 

Но если передать в функцию строка вида ` ; ls`, то команда до точки с запятой пойдёт утилите curl (она выполнится и, возможно, с ошибкой), а последующие команды также будут переданые в bash и проинтерпретированы. В данном случае в итоге в $result запишется содержимое текущей директории (результат работы ls) и выведено на страницу. Это и станет сигналом уязвимости.

#### Semi-blind инъекция
Если не можем отследить выполнение команд, то пробуем добавить строку sleep <time> в код инъекции. Если страница "уснёт" на данное время, то она потенциально уязвима.

#### Blind инъекция
В случае слепой инъекции мы можем только создать файл и проверить его присутсвие:
```
echo "<echo "pwned">" > test.php
```
А затем пробуем обратиться к созданной странице через браузер.

## Эксплуатация
Если мы сдетектировали наличие инъекции, то нужно попробовать следующие вещи:
1) Определить тип ОС, веб-сервера и, по возможности, состояние файловой системы (команды pwd, ls или dir, вывод файлов в stdout командой cat и перемещение по директориям командой cd)
2) Определить ваша права в данной системе (команда whoami). Возможно, ваших прав хватит только на чтение файлов в данной директории. Всё зависит от настройки сервера.
3) Определить возможные исполняемые команды (проверим содержимое /bin и /usr/bin)
4) Проверить данные других пользователей в системе (состояние папки /home и файла /etc/passwd + есть утилиты w и last)
После этого ищем ценные для себя файлы.

При слепой инъекции исхитряемся и перенаправляем stdout в новые файлы, а затем обращаемся к созданным файлам через веб-интерфейс.

В зависимости от своих прав в системе, наличии ценных файлов и отсутсвии страха быть пойманым можно начать искать другие вектора атаки (например, попробовать поднять права до администратора или искать уязвимости в скомпрометированных исходниках).
При возможности создания/скачивания файлов можно создать для себя бэкдор (тема отдельной статьи).

Также необходимо стереть следы проникновения в систему (тоже тема отдельной статьи).

### Инструменты
- Commix – программа для автоматического поиска возможности внедрения команд ОС. Программу Commix нужно запускать от имени администратора. Нужно указать ключ -u с адресом тестируемого веб-приложения (сайта). Адрес должен содержать переменные, которые будут тестироваться.

Пример команды для данной уязвимости:
sudo commix -u http://127.0.0.1:1337/?curl=ya.ru
[kali.tools](https://kali.tools/?p=1107)

## Ущерб
- Компрометация файлов на сервере
- Создаение бэкдора
- Исполнение произвольного кода
В худшем случае хакер может получить полный контроль над уязвимой системой

## Защита
### Основные меры
#### Первый способ
Исключение использования потенциально опасной функции exec(), замена исполняемой функции средствами языка. Например, исполнение curl через bash можно заменить на исполнение библиотечной функции curl в php, работу с файлами можно осуществлять стандартными функциями языка и т.д. 
Если библиотечные функции отстуствуют, то можно попробовать создать собственную реализацию.

#### Второй способ
Если выбросить функцию exec() не представляется возможным, то необходимо предпринять следующие меры:
- Отрегулировать права на доступ к файлам и каталогам на сервере (например, для *nix через функции chmod, chown)
- Фильтровать пользовательский ввод средствами языка (по подстрокам и регулярным выражениям). Потенциально опасные символы – любые разделители shell-команд (';', '&&', '||', '&', '|'), апостро и кавычки.

Пример обнаружения разделителей по регулярному выражению в php:
```
if (preg_match("/[;&|]/", $_GET['curl'])){
  echo "Security alert";
} else {
  curl($_GET['curl']);
}
```

### Превентивные меры
Превентивные меры зависят от ущерба, который уже успел нанести злоумышленник, и степени его закрепления в системе.

## Обход защиты
Иногда можно попробовать обойти плохую фильтрацию пользовательского ввода.

## Дополнительные материалы по теме
- https://hackware.ru/?p=1133 - подробно о command injection
- https://habr.com/ru/company/echelon/blog/337776/ - краткое введение в пентест
- https://www.scip.ch/en/?labs.20181206 - пример эксплойта на bash
